<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Control.Reaper</title><link href="ocean.css" rel="stylesheet" type="text/css" title="Ocean" /><script src="haddock-util.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
window.onload = function () {pageLoad();setSynopsis("mini_Control-Reaper.html");};
//]]>
</script></head><body><div id="package-header"><ul class="links" id="page-menu"><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul><p class="caption">auto-update-0.1.4: Efficiently run periodic, on-demand actions</p></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>Safe</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">Control.Reaper</p></div><div id="table-of-contents"><p class="caption">Contents</p><ul><li><a href="#g:1">Example: Regularly cleaning a cache</a></li><li><a href="#g:2">Settings</a></li><li><a href="#g:3">Accessors</a></li><li><a href="#g:4">Type</a></li><li><a href="#g:5">Creation</a></li><li><a href="#g:6">Helper</a></li></ul></div><div id="description"><p class="caption">Description</p><div class="doc"><p>This module provides the ability to create reapers: dedicated cleanup
 threads. These threads will automatically spawn and die based on the
 presence of a workload to process on. Example uses include:</p><ul><li>Killing long-running jobs </li><li>Closing unused connections in a connection pool</li><li>Pruning a cache of old items (see example below)</li></ul><p>For real-world usage, search the <a href="https://github.com/yesodweb/wai">WAI family of packages</a>
 for imports of <a href="Control-Reaper.html">Control.Reaper</a>.</p></div></div><div id="synopsis"><p id="control.syn" class="caption expander" onclick="toggleSection('syn')">Synopsis</p><ul id="section.syn" class="hide" onclick="toggleSection('syn')"><li class="src short"><span class="keyword">data</span> <a href="#t:ReaperSettings">ReaperSettings</a> workload item</li><li class="src short"><a href="#v:defaultReaperSettings">defaultReaperSettings</a> :: <a href="Control-Reaper.html#t:ReaperSettings">ReaperSettings</a> [item] item</li><li class="src short"><a href="#v:reaperAction">reaperAction</a> :: <a href="Control-Reaper.html#t:ReaperSettings">ReaperSettings</a> workload item -&gt; workload -&gt; <a href="../base-4.8.2.0/System-IO.html#t:IO">IO</a> (workload -&gt; workload)</li><li class="src short"><a href="#v:reaperDelay">reaperDelay</a> :: <a href="Control-Reaper.html#t:ReaperSettings">ReaperSettings</a> workload item -&gt; <a href="../base-4.8.2.0/Data-Int.html#t:Int">Int</a></li><li class="src short"><a href="#v:reaperCons">reaperCons</a> :: <a href="Control-Reaper.html#t:ReaperSettings">ReaperSettings</a> workload item -&gt; item -&gt; workload -&gt; workload</li><li class="src short"><a href="#v:reaperNull">reaperNull</a> :: <a href="Control-Reaper.html#t:ReaperSettings">ReaperSettings</a> workload item -&gt; workload -&gt; <a href="../base-4.8.2.0/Data-Bool.html#t:Bool">Bool</a></li><li class="src short"><a href="#v:reaperEmpty">reaperEmpty</a> :: <a href="Control-Reaper.html#t:ReaperSettings">ReaperSettings</a> workload item -&gt; workload</li><li class="src short"><span class="keyword">data</span> <a href="#t:Reaper">Reaper</a> workload item = <a href="#v:Reaper">Reaper</a> {<ul class="subs"><li><a href="#v:reaperAdd">reaperAdd</a> :: item -&gt; <a href="../base-4.8.2.0/System-IO.html#t:IO">IO</a> ()</li><li><a href="#v:reaperRead">reaperRead</a> :: <a href="../base-4.8.2.0/System-IO.html#t:IO">IO</a> workload</li><li><a href="#v:reaperStop">reaperStop</a> :: <a href="../base-4.8.2.0/System-IO.html#t:IO">IO</a> workload</li><li><a href="#v:reaperKill">reaperKill</a> :: <a href="../base-4.8.2.0/System-IO.html#t:IO">IO</a> ()</li></ul>}</li><li class="src short"><a href="#v:mkReaper">mkReaper</a> :: <a href="Control-Reaper.html#t:ReaperSettings">ReaperSettings</a> workload item -&gt; <a href="../base-4.8.2.0/System-IO.html#t:IO">IO</a> (<a href="Control-Reaper.html#t:Reaper">Reaper</a> workload item)</li><li class="src short"><a href="#v:mkListAction">mkListAction</a> :: (item -&gt; <a href="../base-4.8.2.0/System-IO.html#t:IO">IO</a> (<a href="../base-4.8.2.0/Data-Maybe.html#t:Maybe">Maybe</a> item')) -&gt; [item] -&gt; <a href="../base-4.8.2.0/System-IO.html#t:IO">IO</a> ([item'] -&gt; [item'])</li></ul></div><div id="interface"><h1 id="g:1">Example: Regularly cleaning a cache</h1><div class="doc"><p>In this example code, we use a <code><a href="Data-Map-Strict.html#v:Map">Map</a></code> to cache fibonacci numbers, and a <code><a href="Control-Reaper.html#t:Reaper">Reaper</a></code> to prune the cache. </p><p>The <code>main</code> function first creates a <code><a href="Control-Reaper.html#t:Reaper">Reaper</a></code>, with fields to initialize the 
 cache (<code><a href="Control-Reaper.html#v:reaperEmpty">reaperEmpty</a></code>), add items to it (<code><a href="Control-Reaper.html#v:reaperCons">reaperCons</a></code>), and prune it (<code><a href="Control-Reaper.html#v:reaperAction">reaperAction</a></code>).
 The reaper will run every two seconds (<code><a href="Control-Reaper.html#v:reaperDelay">reaperDelay</a></code>), but will stop running while 
 <code><a href="Control-Reaper.html#v:reaperNull">reaperNull</a></code> is true.</p><p><code>main</code> then loops infinitely (<code><a href="../base-4.8.2.0/Control-Monad.html#v:forever">forever</a></code>). Each second it calculates the fibonacci number 
 for a value between 30 and 34, first trying the cache (<code><a href="Control-Reaper.html#v:reaperRead">reaperRead</a></code> and <code><a href="Data-Map-Strict.html#v:lookup">lookup</a></code>), 
 then falling back to manually calculating it (<code>fib</code>) 
 and updating the cache with the result (<code><a href="Control-Reaper.html#v:reaperAdd">reaperAdd</a></code>)</p><p><code>clean</code> simply removes items cached for more than 10 seconds.
 This function is where you would perform IO-related cleanup,
 like killing threads or closing connections, if that was the purpose of your reaper.</p><pre>module Main where

import <a href="Data-Time.html">Data.Time</a> (UTCTime, getCurrentTime, diffUTCTime)
import <a href="Control-Reaper.html">Control.Reaper</a>
import <a href="../base-4.8.2.0/Control-Concurrent.html">Control.Concurrent</a> (threadDelay)
import <a href="Data-Map-Strict.html">Data.Map.Strict</a> (Map)
import qualified <a href="Data-Map-Strict.html">Data.Map.Strict</a> as Map
import <a href="../base-4.8.2.0/Control-Monad.html">Control.Monad</a> (forever)
import <a href="System-Random.html">System.Random</a> (getStdRandom, randomR)

fib :: <code><a href="../base-4.8.2.0/Data-Int.html#t:Int">Int</a></code> -&gt; <code><a href="../base-4.8.2.0/Data-Int.html#t:Int">Int</a></code>
fib 0 = 0
fib 1 = 1
fib n = fib (n-1) + fib (n-2)

type Cache = <code><a href="Data-Map-Strict.html#v:Map">Map</a></code> <code><a href="../base-4.8.2.0/Data-Int.html#t:Int">Int</a></code> (<code><a href="../base-4.8.2.0/Data-Int.html#t:Int">Int</a></code>, <code><a href="Data-Time-Clock.html#v:UTCTime">UTCTime</a></code>)

main :: IO ()
main = do
  reaper &lt;- <code><a href="Control-Reaper.html#v:mkReaper">mkReaper</a></code> <code><a href="Control-Reaper.html#v:defaultReaperSettings">defaultReaperSettings</a></code>
    { <code><a href="Control-Reaper.html#v:reaperEmpty">reaperEmpty</a></code> = Map.<code><a href="Data-Map-Strict.html#v:empty">empty</a></code>
    , <code><a href="Control-Reaper.html#v:reaperCons">reaperCons</a></code> = \(k, v, time) workload -&gt; Map.<code><a href="Data-Map-Strict.html#v:insert">insert</a></code> k (v, time) workload
    , <code><a href="Control-Reaper.html#v:reaperAction">reaperAction</a></code> = clean
    , <code><a href="Control-Reaper.html#v:reaperDelay">reaperDelay</a></code> = 1000000 * 2 -- Clean every 2 seconds
    , <code><a href="Control-Reaper.html#v:reaperNull">reaperNull</a></code> = Map.<code><a href="Data-Map-Strict.html#v:null">null</a></code>
    }
  forever $ do
    fibArg &lt;- <code><a href="System-Random.html#v:getStdRandom">getStdRandom</a></code> (<code><a href="System-Random.html#v:randomR">randomR</a></code> (30,34))
    cache &lt;- <code><a href="Control-Reaper.html#v:reaperRead">reaperRead</a></code> reaper
    let cachedResult = Map.<code><a href="Data-Map-Strict.html#v:lookup">lookup</a></code> fibArg cache
    case cachedResult of
      <code><a href="../base-4.8.2.0/Data-Maybe.html#v:Just">Just</a></code> (fibResult, _createdAt) -&gt; <code><a href="../base-4.8.2.0/System-IO.html#v:putStrLn">putStrLn</a></code> $ &quot;Found in cache: `fib &quot; ++ <code><a href="../base-4.8.2.0/Text-Show.html#v:show">show</a></code> fibArg ++ &quot;` &quot; ++ <code><a href="../base-4.8.2.0/Text-Show.html#v:show">show</a></code> fibResult
      <code><a href="../base-4.8.2.0/Data-Maybe.html#v:Nothing">Nothing</a></code> -&gt; do
        let fibResult = fib fibArg
        <code><a href="../base-4.8.2.0/System-IO.html#v:putStrLn">putStrLn</a></code> $ &quot;Calculating `fib &quot; ++ <code><a href="../base-4.8.2.0/Text-Show.html#v:show">show</a></code> fibArg ++ &quot;` &quot; ++ <code><a href="../base-4.8.2.0/Text-Show.html#v:show">show</a></code> fibResult
        time &lt;- <code><a href="Data-Time-Clock.html#v:getCurrentTime">getCurrentTime</a></code>
        (<code><a href="Control-Reaper.html#v:reaperAdd">reaperAdd</a></code> reaper) (fibArg, fibResult, time)
    <code><a href="../base-4.8.2.0/Control-Concurrent.html#v:threadDelay">threadDelay</a></code> 1000000 -- 1 second

-- Remove items &gt; 10 seconds old
clean :: Cache -&gt; IO (Cache -&gt; Cache)
clean oldMap = do
  currentTime &lt;- <code><a href="Data-Time-Clock.html#v:getCurrentTime">getCurrentTime</a></code>
  let pruned = Map.<code><a href="Data-Map-Strict.html#v:filter">filter</a></code> (\(_, createdAt) -&gt; currentTime `diffUTCTime` createdAt &lt; 10.0) oldMap
  return (\newData -&gt; Map.<code><a href="Data-Map-Strict.html#v:union">union</a></code> pruned newData)
</pre></div><h1 id="g:2">Settings</h1><div class="top"><p class="src"><span class="keyword">data</span> <a name="t:ReaperSettings" class="def">ReaperSettings</a> workload item</p><div class="doc"><p>Settings for creating a reaper. This type has two parameters:
 <code>workload</code> gives the entire workload, whereas <code>item</code> gives an
 individual piece of the queue. A common approach is to have <code>workload</code>
 be a list of <code>item</code>s. This is encouraged by <code><a href="Control-Reaper.html#v:defaultReaperSettings">defaultReaperSettings</a></code> and
 <code><a href="Control-Reaper.html#v:mkListAction">mkListAction</a></code>.</p><p><em>Since: 0.1.1</em></p></div></div><div class="top"><p class="src"><a name="v:defaultReaperSettings" class="def">defaultReaperSettings</a> :: <a href="Control-Reaper.html#t:ReaperSettings">ReaperSettings</a> [item] item</p><div class="doc"><p>Default <code>ReaperSettings</code> value, biased towards having a list of work
 items.</p><p><em>Since: 0.1.1</em></p></div></div><h1 id="g:3">Accessors</h1><div class="top"><p class="src"><a name="v:reaperAction" class="def">reaperAction</a> :: <a href="Control-Reaper.html#t:ReaperSettings">ReaperSettings</a> workload item -&gt; workload -&gt; <a href="../base-4.8.2.0/System-IO.html#t:IO">IO</a> (workload -&gt; workload)</p><div class="doc"><p>The action to perform on a workload. The result of this is a
 &quot;workload modifying&quot; function. In the common case of using lists,
 the result should be a difference list that prepends the remaining
 workload to the temporary workload. For help with setting up such
 an action, see <code><a href="Control-Reaper.html#v:mkListAction">mkListAction</a></code>.</p><p>Default: do nothing with the workload, and then prepend it to the
 temporary workload. This is incredibly useless; you should
 definitely override this default.</p><p><em>Since: 0.1.1</em></p></div></div><div class="top"><p class="src"><a name="v:reaperDelay" class="def">reaperDelay</a> :: <a href="Control-Reaper.html#t:ReaperSettings">ReaperSettings</a> workload item -&gt; <a href="../base-4.8.2.0/Data-Int.html#t:Int">Int</a></p><div class="doc"><p>Number of microseconds to delay between calls of <code><a href="Control-Reaper.html#v:reaperAction">reaperAction</a></code>.</p><p>Default: 30 seconds.</p><p><em>Since: 0.1.1</em></p></div></div><div class="top"><p class="src"><a name="v:reaperCons" class="def">reaperCons</a> :: <a href="Control-Reaper.html#t:ReaperSettings">ReaperSettings</a> workload item -&gt; item -&gt; workload -&gt; workload</p><div class="doc"><p>Add an item onto a workload.</p><p>Default: list consing.</p><p><em>Since: 0.1.1</em></p></div></div><div class="top"><p class="src"><a name="v:reaperNull" class="def">reaperNull</a> :: <a href="Control-Reaper.html#t:ReaperSettings">ReaperSettings</a> workload item -&gt; workload -&gt; <a href="../base-4.8.2.0/Data-Bool.html#t:Bool">Bool</a></p><div class="doc"><p>Check if a workload is empty, in which case the worker thread
 will shut down.</p><p>Default: <code><a href="../base-4.8.2.0/Data-Foldable.html#v:null">null</a></code>.</p><p><em>Since: 0.1.1</em></p></div></div><div class="top"><p class="src"><a name="v:reaperEmpty" class="def">reaperEmpty</a> :: <a href="Control-Reaper.html#t:ReaperSettings">ReaperSettings</a> workload item -&gt; workload</p><div class="doc"><p>An empty workload.</p><p>Default: empty list.</p><p><em>Since: 0.1.1</em></p></div></div><h1 id="g:4">Type</h1><div class="top"><p class="src"><span class="keyword">data</span> <a name="t:Reaper" class="def">Reaper</a> workload item</p><div class="doc"><p>A data structure to hold reaper APIs.</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a name="v:Reaper" class="def">Reaper</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><dl><dt class="src"><a name="v:reaperAdd" class="def">reaperAdd</a> :: item -&gt; <a href="../base-4.8.2.0/System-IO.html#t:IO">IO</a> ()</dt><dd class="doc"><p>Adding an item to the workload</p></dd><dt class="src"><a name="v:reaperRead" class="def">reaperRead</a> :: <a href="../base-4.8.2.0/System-IO.html#t:IO">IO</a> workload</dt><dd class="doc"><p>Reading workload.</p></dd><dt class="src"><a name="v:reaperStop" class="def">reaperStop</a> :: <a href="../base-4.8.2.0/System-IO.html#t:IO">IO</a> workload</dt><dd class="doc"><p>Stopping the reaper thread if exists.
   The current workload is returned.</p></dd><dt class="src"><a name="v:reaperKill" class="def">reaperKill</a> :: <a href="../base-4.8.2.0/System-IO.html#t:IO">IO</a> ()</dt><dd class="doc"><p>Killing the reaper thread immediately if exists.</p></dd></dl><div class="clear"></div></div></td></tr></table></div></div><h1 id="g:5">Creation</h1><div class="top"><p class="src"><a name="v:mkReaper" class="def">mkReaper</a> :: <a href="Control-Reaper.html#t:ReaperSettings">ReaperSettings</a> workload item -&gt; <a href="../base-4.8.2.0/System-IO.html#t:IO">IO</a> (<a href="Control-Reaper.html#t:Reaper">Reaper</a> workload item)</p><div class="doc"><p>Create a reaper addition function. This function can be used to add
 new items to the workload. Spawning of reaper threads will be handled
 for you automatically.</p><p><em>Since: 0.1.1</em></p></div></div><h1 id="g:6">Helper</h1><div class="top"><p class="src"><a name="v:mkListAction" class="def">mkListAction</a> :: (item -&gt; <a href="../base-4.8.2.0/System-IO.html#t:IO">IO</a> (<a href="../base-4.8.2.0/Data-Maybe.html#t:Maybe">Maybe</a> item')) -&gt; [item] -&gt; <a href="../base-4.8.2.0/System-IO.html#t:IO">IO</a> ([item'] -&gt; [item'])</p><div class="doc"><p>A helper function for creating <code><a href="Control-Reaper.html#v:reaperAction">reaperAction</a></code> functions. You would
 provide this function with a function to process a single work item and
 return either a new work item, or <code>Nothing</code> if the work item is
 expired.</p><p><em>Since: 0.1.1</em></p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.16.1</p></div></body></html>